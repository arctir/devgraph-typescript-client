name: Regenerate TypeScript Client

on:
  workflow_dispatch:
    inputs:
      spec_version:
        description: 'API Version from devgraph-api'
        required: true
        type: string
      spec_commit:
        description: 'Commit SHA from devgraph-api'
        required: true
        type: string

jobs:
  regenerate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ARCTIR_GH_ACTIONS_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@arctir'

      - name: Download OpenAPI spec
        run: |
          curl -L -o openapi.yaml \
            "https://raw.githubusercontent.com/arctir/devgraph-api/${{ inputs.spec_commit }}/v1/spec.yaml"
          echo "âœ“ Downloaded spec from commit ${{ inputs.spec_commit }}"

      - name: Remove old generated code
        run: |
          rm -rf src/generated
          mkdir -p src/generated

      - name: Generate TypeScript client
        run: |
          npm install
          npx @hey-api/openapi-ts \
            --input openapi.yaml \
            --output src/generated
          echo "âœ“ Generated TypeScript client"

      - name: Update client version
        run: |
          npm version ${{ inputs.spec_version }} --no-git-tag-version
          echo "âœ“ Updated version to ${{ inputs.spec_version }}"

      - name: Build
        run: npm run build

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        run: |
          git add .
          git commit -m "chore: regenerate client for API v${{ inputs.spec_version }}

          Generated from devgraph-api commit ${{ inputs.spec_commit }}

          ðŸ¤– Auto-generated by GitHub Actions" || echo "No changes to commit"

          git push origin main

          git tag -fa "v${{ inputs.spec_version }}" -m "TypeScript client v${{ inputs.spec_version }}"
          git push -f origin "v${{ inputs.spec_version }}"

          echo "âœ“ Pushed changes and tag v${{ inputs.spec_version }}"

      - name: Publish to GitHub npm registry
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create summary
        run: |
          echo "## âœ“ TypeScript Client Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **API Version**: \`${{ inputs.spec_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Spec Commit**: \`${{ inputs.spec_commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Package**: [@arctir/devgraph-client](https://github.com/arctir/devgraph-typescript-client/pkgs/npm/devgraph-client)" >> $GITHUB_STEP_SUMMARY
