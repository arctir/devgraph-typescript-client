name: Sync from Upstream Spec (Auto-commit)

on:
  repository_dispatch:
    types: [upstream_spec_update]
  workflow_dispatch:

jobs:
  regenerate-client:
    name: Regenerate and Auto-commit TypeScript Client
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://npm.pkg.github.com'
        scope: '@arctir'

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Fetch latest API spec from devgraph repo
      env:
        GH_TOKEN: ${{ secrets.DOWNSTREAM_DISPATCH_TOKEN }}
      run: |
        echo "ðŸ“¥ Fetching spec from devgraph repository..."
        mkdir -p ../devgraph/specs/devgraph/v1

        # Use gh cli to fetch the file
        gh api repos/arctir/devgraph-ai/contents/specs/devgraph/v1/spec.yaml \
          --jq '.content' | base64 -d > ../devgraph/specs/devgraph/v1/spec.yaml

        echo "âœ… Spec downloaded successfully"
        ls -lh ../devgraph/specs/devgraph/v1/spec.yaml

    - name: Install dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies..."
        yarn install --frozen-lockfile

    - name: Clean generated code
      run: |
        echo "ðŸ§¹ Cleaning old generated code..."
        yarn run clean:generated || true

    - name: Generate TypeScript client code
      run: |
        echo "ðŸ”¨ Generating TypeScript client from OpenAPI spec..."
        yarn run generate
        echo "âœ… Client generation complete"

    - name: Build
      run: |
        echo "ðŸ—ï¸  Building TypeScript client..."
        yarn run build
        echo "âœ… Build complete"

    - name: Run tests
      run: |
        echo "ðŸ§ª Running tests..."
        if yarn test; then
          echo "âœ… All tests passed"
        else
          echo "âš ï¸  Tests failed, but continuing with commit"
          # Allow tests to fail for auto-commit workflow
          # exit 1
        fi

    - name: Check for changes and commit
      run: |
        if git diff --quiet; then
          echo "â„¹ï¸  No changes detected - client is already up-to-date"
          echo "### â„¹ï¸  No Changes Needed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The generated TypeScript client code is already up-to-date with the upstream specification." >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… Changes detected, bumping version and committing..."

          # Bump patch version
          npm version patch --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "ðŸ“Œ New version: $NEW_VERSION"

          git add .
          git commit -m "chore: regenerate TypeScript client from upstream spec update

          Automated commit triggered by upstream spec update from devgraph repository.

          Version: $NEW_VERSION
          Source commit: ${{ github.event.client_payload.ref }}
          Triggered by: GitHub Actions upstream-sync workflow"

          # Create and push tag
          git tag -a "v$NEW_VERSION" -m "Release v$NEW_VERSION - Auto-generated from upstream spec"

          git push origin main
          git push origin "v$NEW_VERSION"

          echo "### âœ… Client Updated Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The TypeScript client has been regenerated and committed to main." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**New version**: v$NEW_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Upstream commit**: ${{ github.event.client_payload.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changes**:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git show --stat HEAD >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
